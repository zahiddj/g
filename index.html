<!DOCTYPE html>
<html>
<head>
    <title>Advanced Memory Collector</title>
    <style>
        * { margin: 0; padding: 0; }
        body { overflow: hidden; }
        #hud {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #fff;
            font-family: Arial;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            z-index: 1000;
        }
        #story {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            padding: 20px;
            color: white;
            max-width: 500px;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>
    <div id="hud">
        <div>Memories: <span id="score">0</span>/12</div>
        <div>Time: <span id="time">Day</span></div>
    </div>
    <div id="story">
        <h2>The Forgotten Village</h2>
        <p>Young explorer Alex must recover the village's lost memories before time runs out...</p>
        <button onclick="startGame()">Begin Adventure</button>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

<script>
'use strict';

class AdvancedGame {
    constructor() {
        this.score = 0;
        this.dayTime = 0;
        this.collectibles = [];
        this.init();
    }

    async init() {
        try {
            // 1. Scene Setup
            this.scene = new THREE.Scene();
            this.camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            this.renderer = new THREE.WebGLRenderer({ antialias: true });
            this.renderer.shadowMap.enabled = true;
            this.renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(this.renderer.domElement);

            // 2. Advanced Lighting
            this.setupLighting();
            
            // 3. Environment
            await this.createEnvironment();
            
            // 4. Character
            await this.loadCharacter();
            
            // 5. Game Mechanics
            this.setupControls();
            this.createCollectibles();
            this.setupDayNightCycle();

            // 6. Start Game
            this.animate();
            document.getElementById('story').style.display = 'block';

        } catch (error) {
            console.error('Initialization error:', error);
            alert('Game failed to initialize. Check console for details.');
        }
    }

    setupLighting() {
        // HDR Environment Lighting
        const envTexture = new THREE.CubeTextureLoader()
            .setPath('https://threejs.org/examples/textures/cube/pisa/')
            .load(['px.png', 'nx.png', 'py.png', 'ny.png', 'pz.png', 'nz.png']);
        
        this.scene.environment = envTexture;
        this.scene.background = envTexture;

        // Directional Light
        this.directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        this.directionalLight.position.set(0, 50, 50);
        this.directionalLight.castShadow = true;
        this.scene.add(this.directionalLight);
    }

    async createEnvironment() {
        // Ground with displacement map
        const groundGeometry = new THREE.PlaneGeometry(200, 200, 50, 50);
        const groundMaterial = new THREE.MeshStandardMaterial({
            color: 0x3c8f3c,
            displacementScale: 0.1,
            metalness: 0.3,
            roughness: 0.8
        });
        
        const ground = new THREE.Mesh(groundGeometry, groundMaterial);
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        this.scene.add(ground);

        // Load environment models
        await this.loadGLTFModel('https://cdn.jsdelivr.net/gh/mrdoob/three.js/examples/models/gltf/DamagedHelmet/glTF/DamagedHelmet.gltf', [0, 0, 0]);
    }

    async loadCharacter() {
        const loader = new THREE.GLTFLoader();
        const character = await new Promise((resolve, reject) => {
            loader.load('https://cdn.jsdelivr.net/gh/mrdoob/three.js/examples/models/gltf/Xbot/glTF/Xbot.gltf', resolve, null, reject);
        });
        
        this.character = character.scene;
        this.character.scale.set(0.5, 0.5, 0.5);
        this.character.position.set(0, 0, 0);
        this.character.traverse(child => {
            if (child.isMesh) child.castShadow = true;
        });
        this.scene.add(this.character);
    }

    createCollectibles() {
        const memoryGeometry = new THREE.IcosahedronGeometry(1, 3);
        const memoryMaterial = new THREE.MeshStandardMaterial({
            color: 0xFFD700,
            emissive: 0xFFD700,
            emissiveIntensity: 0.5,
            metalness: 0.8,
            roughness: 0.2
        });

        for(let i = 0; i < 12; i++) {
            const memory = new THREE.Mesh(memoryGeometry, memoryMaterial);
            memory.position.set(
                Math.random() * 80 - 40,
                1.5,
                Math.random() * 80 - 40
            );
            memory.castShadow = true;
            this.collectibles.push(memory);
            this.scene.add(memory);
        }
    }

    setupControls() {
        this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
        this.camera.position.set(0, 15, 30);
        this.controls.target.set(0, 0, 0);
        this.controls.update();
    }

    setupDayNightCycle() {
        this.dayNightCycle = {
            speed: 0.0002,
            time: 0
        };
    }

    animate() {
        requestAnimationFrame(() => this.animate());
        
        // Update day/night cycle
        this.dayNightCycle.time += this.dayNightCycle.speed;
        this.directionalLight.intensity = Math.sin(this.dayNightCycle.time) * 0.5 + 0.5;
        document.getElementById('time').textContent = 
            this.directionalLight.intensity > 0.5 ? 'Day' : 'Night';

        // Rotate collectibles
        this.collectibles.forEach(mem => {
            mem.rotation.y += 0.01;
            mem.position.y = Math.sin(Date.now() * 0.001 + mem.uuid) * 0.5 + 1.5;
        });

        this.controls.update();
        this.renderer.render(this.scene, this.camera);
    }

    async loadGLTFModel(url, position) {
        const loader = new THREE.GLTFLoader();
        const model = await new Promise((resolve, reject) => {
            loader.load(url, resolve, null, reject);
        });
        model.scene.position.set(...position);
        this.scene.add(model.scene);
    }
}

function startGame() {
    document.getElementById('story').style.display = 'none';
    new AdvancedGame();
}
</script>
</body>
</html>
